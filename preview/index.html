<!DOCTYPE html>
<html>
  <body>
    <textarea></textarea>
    <script src="./Fcitx5.js"></script>
    <script>
      const textarea = document.querySelector('textarea')
      let focus = false
      textarea.addEventListener('focus', () => {
        focus = true
        Module.ccall('focus_in', 'void', [], [])
      })
      textarea.addEventListener('blur', () => {
        focus = false
        Module.ccall('focus_out', 'void', [], [])
      })
      textarea.addEventListener('keydown', e => {
        if (!focus) {
          return
        }
        console.log(Module.ccall('process_key', 'bool', ['string'], [e.key]))
      })
      window.fcitx = {
        createPanel(html) {
          const tree = document.createElement('div')
          tree.innerHTML = html
          for (let el of [...tree.children]) {
            switch (el.tagName) {
            case 'STYLE':
              document.head.append(el)
              break
            case 'DIV':
              document.body.append(el)
              break
            case 'SCRIPT':
              eval(el.textContent)
              break
            }
          }
        }
      }
      const apis = [
        'log',
        'copyHTML',
        'select',
        'highlight',
        'page',
        'scroll',
        'askActions',
        'action',
        'resize'
      ]
      for (const api of apis) {
        const name = '_' + api
        window.fcitx[name] = (...args) => Module.ccall('web_action', 'void', ['string', 'string'], [name, JSON.stringify(args)])
      }
    </script>
  </body>
</html>
